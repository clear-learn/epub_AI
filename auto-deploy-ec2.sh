#!/bin/bash
# νμΌ λ³€κ²½ κ°μ§€ β†’ μλ™μΌλ΅ EC2μ— λ°°ν¬

echo "π¤– μλ™ EC2 λ°°ν¬ λ¨λ“ μ‹μ‘..."
echo "π“ κ°μ‹ λ””λ ‰ν† λ¦¬: $(pwd)"
echo "π“΅ λ°°ν¬ λ€μƒ: ubuntu@ec2-3-38-101-46.ap-northeast-2.compute.amazonaws.com"
echo "π”„ νμΌ λ³€κ²½ μ‹ μλ™μΌλ΅ EC2μ— λ°°ν¬ν•©λ‹λ‹¤."
echo "βΉοΈ  μ¤‘μ§€ν•λ ¤λ©΄ Ctrl+Cλ¥Ό λ„λ¥΄μ„Έμ”."
echo ""

# λ§μ§€λ§‰ λ°°ν¬ μ‹κ°„
LAST_DEPLOY=0

while true; do
    # νμΌ λ³€κ²½ κ°μ§€ (git μ‚¬μ©)
    if git diff-index --quiet HEAD -- 2>/dev/null; then
        # λ³€κ²½μ‚¬ν•­ μ—†μ
        sleep 3
        continue
    fi

    # ν„μ¬ μ‹κ°„
    CURRENT_TIME=$(date +%s)

    # λ§μ§€λ§‰ λ°°ν¬λ΅λ¶€ν„° 5μ΄ μ΄μƒ κ²½κ³Όν–λ”μ§€ ν™•μΈ (μ¤‘λ³µ λ°°ν¬ λ°©μ§€)
    if [ $((CURRENT_TIME - LAST_DEPLOY)) -lt 5 ]; then
        sleep 3
        continue
    fi

    echo ""
    echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    echo "π“ λ³€κ²½ κ°μ§€! EC2λ΅ λ°°ν¬ μ‹μ‘... ($(date +"%H:%M:%S"))"
    echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

    # λ°°ν¬ μ¤ν¬λ¦½νΈ μ‹¤ν–‰
    if ./deploy-to-ec2.sh; then
        echo ""
        echo "β… λ°°ν¬ μ„±κ³µ! ($(date +"%H:%M:%S"))"
        LAST_DEPLOY=$(date +%s)
    else
        echo ""
        echo "β λ°°ν¬ μ‹¤ν¨! μ¤λ¥λ¥Ό ν™•μΈν•μ„Έμ”."
    fi

    echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    echo "β³ λ‹¤μ λ³€κ²½μ‚¬ν•­ κ°μ‹ μ¤‘..."
    echo ""

    sleep 3
done